{% extends 'ecom/customer_base.html' %}
{% load static %}

{% block content %}
<head>
    <script async src="https://pay.google.com/gp/p/js/pay.js"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #e0f7fa, #e1bee7);
        }

        .payment-container {
            max-width: 600px;
            margin: 60px auto;
            padding: 30px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            text-align: center;
        }

        .payment-header {
            font-size: 28px;
            font-weight: 700;
            color: #1a237e;
            margin-bottom: 20px;
        }

        .marquee-box {
            background: linear-gradient(135deg, #ff9800, #ffc107);
            color: #1a237e;
            font-weight: 600;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .final-amount {
            background: #1a237e;
            color: white;
            font-size: 20px;
            font-weight: 600;
            padding: 15px;
            border-radius: 12px;
            margin: 20px 0;
            box-shadow: 0 6px 16px rgba(26, 35, 126, 0.3);
        }

        .pay-btn {
            display: block;
            width: 45%;
            height: fit-content;
            margin: 15px auto;
            padding: 10px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            color: white;
            text-decoration: none;
            transition: transform 0.2s ease, box-shadow 0.3s ease;
        }

        .pay-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.25);
            color: white;
             text-decoration: none;
        }

        .stripe-btn {
            background: linear-gradient(135deg, #635bff, #7c4dff);
        }

        .phonepe-btn {
            background: linear-gradient(135deg, #8e24aa, #ab47bc);
        }

        #gpay-container {
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .payment-container {
                width: 90%;
                padding: 20px;
            }
            .pay-btn {
                width: 90%;
            }
        }
    </style>
</head>

<div class="payment-container">
    <div class="marquee-box">ITS FAKE PAYMENT PAGE. WE DO NOT STORE YOUR DATA</div>
    <div class="marquee-box">ITS JUST FOR DEMO</div>

    <div class="payment-header">Complete Your Payment</div>
    <div class="final-amount">
        Final Amount: â‚¹ {{ total|floatformat:2 }}
    </div>

    <a href="/stripe-payment" class="pay-btn stripe-btn" style=" text-decoration: none; color: white;">Pay with Stripe</a>
    <a href="/phonepe-payment" class="pay-btn phonepe-btn" style=" text-decoration: none; color: white;">Pay with PhonePe</a>

    <div id="gpay-container"></div>
</div>

<script>
    window.onload = function () {
        if (!window.google) {
            console.error("Google Pay script not loaded.");
            return;
        }

        const paymentsClient = new google.payments.api.PaymentsClient({ environment: 'TEST' });

        const paymentRequest = {
            apiVersion: 2,
            apiVersionMinor: 0,
            allowedPaymentMethods: [{
                type: 'CARD',
                parameters: {
                    allowedAuthMethods: ['PAN_ONLY', 'CRYPTOGRAM_3DS'],
                    allowedCardNetworks: ['MASTERCARD', 'VISA']
                },
                tokenizationSpecification: {
                    type: 'PAYMENT_GATEWAY',
                    parameters: {
                        gateway: 'stripe',
                        'stripe:version': '2020-08-27',
                        'stripe:publishableKey': '{{ stripe_publishable_key }}'
                    }
                }
            }],
            merchantInfo: {
                merchantId: '12345678901234567890',
                merchantName: 'Test Merchant'
            },
            transactionInfo: {
                totalPriceStatus: 'FINAL',
                totalPrice: '{{ total|floatformat:2 }}',
                currencyCode: 'INR',
                countryCode: 'IN'
            }
        };

        const container = document.getElementById('gpay-container');
        const button = paymentsClient.createButton({
            buttonColor: 'black',
            buttonType: 'pay',
            buttonRadius: 6,
            onClick: () => {
                paymentsClient.loadPaymentData(paymentRequest)
                    .then(paymentData => {
                        const form = document.createElement('form');
                        form.method = 'POST';
                        form.action = '/gpay-payment/';

                        const csrfInput = document.createElement('input');
                        csrfInput.type = 'hidden';
                        csrfInput.name = 'csrfmiddlewaretoken';
                        csrfInput.value = '{{ csrf_token }}';
                        form.appendChild(csrfInput);

                        const paymentInput = document.createElement('input');
                        paymentInput.type = 'hidden';
                        paymentInput.name = 'paymentData';
                        paymentInput.value = JSON.stringify(paymentData);
                        form.appendChild(paymentInput);

                        document.body.appendChild(form);
                        form.submit();
                    })
                    .catch(err => console.error('Google Pay Error:', err));
            },
            allowedPaymentMethods: paymentRequest.allowedPaymentMethods
        });
        container.appendChild(button);
    };
</script>
{% endblock content %}
